@using BlazorFrontend.Services
@inherits LayoutComponentBase
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IAuthState AuthState
@inject LocalStorageService Storage
@inject ISnackbar Snackbar

<MudThemeProvider/>
<MudPopoverProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                       OnClick="@ToggleDrawer"/>
        <MudText Typo="Typo.h6">MEAD - Medication Tracker</MudText>
        <MudSpacer/>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Inherit"
                   StartIcon="@Icons.Material.Filled.Logout"
                   OnClick="LogoutAsync"
                   Size="Size.Small">
            Logout
        </MudButton>
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <MudDrawerHeader>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Medication" Color="Color.Primary" Size="Size.Large"/>
                <MudText Typo="Typo.h6">MEAD</MudText>
            </MudStack>
        </MudDrawerHeader>

        <MudNavMenu>
            <MudNavLink Href="/" Icon="@Icons.Material.Filled.Dashboard" Match="NavLinkMatch.All">Dashboard</MudNavLink>
            <MudNavLink Href="/medications" Icon="@Icons.Material.Filled.Medication" Match="NavLinkMatch.All">
                Medications
            </MudNavLink>
            <MudNavLink Href="/schedule" Icon="@Icons.Material.Filled.Schedule" Match="NavLinkMatch.All">Schedule
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _drawerOpen = true;

    void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task LogoutAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthApi");

            // POST auth/logout with empty body
            await client.PostAsync("auth/logout", content: null);

            // Clear local auth state (token, userId, etc.)
            await AuthState.ClearAsync();

            Snackbar.Add("Logged out successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Logout failed. Redirecting anyway...", Severity.Warning);
        }

        // Redirect to login page
        Navigation.NavigateTo("/login", forceLoad: true);
    }

}