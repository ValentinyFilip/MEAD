@inherits LayoutComponentBase
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IAuthState AuthState
@inject LocalStorageService Storage
@inject ISnackbar Snackbar
@using BlazorFrontend.Common
@using BlazorFrontend.Services
@implements IDisposable

<MudThemeProvider Theme="@_theme"/>
<MudPopoverProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@(() => _drawerOpen = !_drawerOpen)"/>
        <MudText Typo="Typo.h5" Class="ml-3">Mead</MudText>
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen"
               Elevation="2"
               Color="Color.Surface"
               ClipMode="DrawerClipMode.Always">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">Medication Tracker</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
                Home
            </MudNavLink>
            <MudNavLink Href="/warehouse" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Inventory">
                Warehouse
            </MudNavLink>
            <MudNavLink Href="/schedules" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Schedule">
                Schedules
            </MudNavLink>
            <MudDivider Class="my-2"/>
            <MudNavLink OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout">
                Logout
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent Class="pt-16 px-16">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _drawerOpen = true;

    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#2196F3",
            Secondary = "#64B5F6",
            AppbarBackground = "#2196F3",
            Background = "#FFFFFF",
            Surface = "#FFFFFF",
            DrawerBackground = "#FFFFFF",
            DrawerText = "rgba(0,0,0,0.87)",
            DrawerIcon = "rgba(0,0,0,0.54)",
            AppbarText = "#FFFFFF",
            TextPrimary = "rgba(0,0,0,0.87)",
            TextSecondary = "#757575",
            ActionDefault = "#9E9E9E",
            ActionDisabled = "rgba(0,0,0,0.26)",
            Divider = "#E0E0E0",
            Success = "#4CAF50",
            Info = "#2196F3",
            Warning = "#FF9800",
            Error = "#F44336",
            HoverOpacity = 0.04
        },
        LayoutProperties = new LayoutProperties()
    };

    protected override void OnInitialized()
    {
        AuthenticatedHttpMessageHandler.OnUnauthorized += HandleUnauthorized;
    }

    private async Task HandleUnauthorized()
    {
        await InvokeAsync(() =>
        {
            Snackbar.Add("Session expired. Please login again.", Severity.Warning);
            Navigation.NavigateTo("/login", forceLoad: true);
        });
    }

    private async Task LogoutAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthApi");
            await client.PostAsync("auth/logout", content: null);
            await AuthState.ClearAsync();
            Snackbar.Add("Logged out successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Logout failed. Redirecting anyway...", Severity.Warning);
        }

        Navigation.NavigateTo("/login", forceLoad: true);
    }

    public void Dispose()
    {
        AuthenticatedHttpMessageHandler.OnUnauthorized -= HandleUnauthorized;
    }

}
