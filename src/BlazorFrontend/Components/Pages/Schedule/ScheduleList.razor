@page "/schedules"
@using BlazorFrontend.Components.Dialogs
@using BlazorFrontend.Dtos
@using BlazorFrontend.Services
@rendermode InteractiveServer
@inject ScheduleService ScheduleService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Schedules - Mead</PageTitle>

<div class="d-flex justify-space-between align-center mb-6">
    <div>
        <MudText Typo="Typo.h3">Medication Schedules</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Manage your medication schedules</MudText>
    </div>
    <MudFab Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.Add"
            OnClick="OpenAddDialog"
            Label="Add Schedule"/>
</div>

@if (_isLoading)
{
    <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large"/>
    </div>
}
else if (_hasError)
{
    <MudPaper Elevation="0" Class="pa-16 d-flex flex-column align-center">
        <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Large" Color="Color.Error" Class="mb-4"
                 Style="font-size: 4rem;"/>
        <MudText Typo="Typo.h5" Class="mb-2">Unable to Load Schedules</MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">@_errorMessage</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="LoadSchedules">
            Try Again
        </MudButton>
    </MudPaper>
}
else if (_schedules.Count == 0)
{
    <MudPaper Elevation="0" Class="pa-16 d-flex flex-column align-center">
        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Large" Color="Color.Primary" Class="mb-4"
                 Style="font-size: 4rem;"/>
        <MudText Typo="Typo.h5" Class="mb-2">No schedules yet</MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">Create your first medication schedule</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddDialog">
            Add First Schedule
        </MudButton>
    </MudPaper>
}
else
{
    <MudTable Items="@_schedules.OrderByDescending(s => s.IsActive).ThenBy(s => s.StartsOn)"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              Elevation="2">
        <HeaderContent>
            <MudTh>Medication</MudTh>
            <MudTh>Dosage</MudTh>
            <MudTh>Frequency</MudTh>
            <MudTh>Starts</MudTh>
            <MudTh>Ends</MudTh>
            <MudTh>Status</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Medication">
                <MudText Typo="Typo.body1"><strong>@context.MedicationName</strong></MudText>
            </MudTd>
            <MudTd DataLabel="Dosage">
                <MudText Typo="Typo.body2">@context.AmountPerTime @context.AmountUnit</MudText>
            </MudTd>
            <MudTd DataLabel="Frequency">
                <div>
                    <MudText Typo="Typo.body2">@string.Join(", ", context.TimesPerDay)</MudText>
                    <MudText Typo="Typo.caption"
                             Color="Color.Secondary">@FormatEnumName(context.HowOften.ToString())</MudText>
                </div>
            </MudTd>
            <MudTd DataLabel="Starts">
                <MudText Typo="Typo.body2">@context.StartsOn.ToString("MMM dd, yyyy")</MudText>
            </MudTd>
            <MudTd DataLabel="Ends">
                @if (context.EndsOn.HasValue)
                {
                    var isExpired = context.EndsOn.Value < DateTime.UtcNow;
                    <MudText Typo="Typo.body2" Color="@(isExpired ? Color.Error : Color.Default)">
                        @context.EndsOn.Value.ToString("MMM dd, yyyy")
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Ongoing</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Status">
                @if (context.IsActive && !context.IsExpired)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small"
                             Icon="@Icons.Material.Filled.CheckCircle">
                        Active
                    </MudChip>
                }
                else if (context.IsExpired)
                {
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Icon="@Icons.Material.Filled.EventBusy">
                        Expired
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small"
                             Icon="@Icons.Material.Filled.PauseCircle">
                        Inactive
                    </MudChip>
                }
            </MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Size="Size.Small"
                               Color="Color.Error"
                               OnClick="@(() => DeleteSchedule(context.Id))"/>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private List<ScheduleDto> _schedules = [];
    private bool _isLoading = true;
    private bool _hasError = false;
    private string _errorMessage = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadSchedules();
            StateHasChanged();
        }
    }

    private async Task LoadSchedules()
    {
        _isLoading = true;
        _hasError = false;
        _errorMessage = "";

        try
        {
            _schedules = await ScheduleService.GetSchedulesAsync();
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login?error=expired");
            return;
        }
        catch (HttpRequestException ex)
        {
            _hasError = true;
            _errorMessage = ex.StatusCode == System.Net.HttpStatusCode.NotFound
                ? "Schedules endpoint not found. Please check your API configuration."
                : "Unable to connect to the server. Please check your connection.";
        }
        catch (Exception ex)
        {
            _hasError = true;
            _errorMessage = "An unexpected error occurred while loading schedules.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenAddDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddScheduleDialog>("Add Schedule", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadSchedules();
            Snackbar.Add("Schedule added successfully", Severity.Success);
        }
    }

    private async Task DeleteSchedule(Guid scheduleId)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Delete Schedule",
            "Are you sure you want to delete this schedule?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ScheduleService.DeleteScheduleAsync(scheduleId);
                await LoadSchedules();
                Snackbar.Add("Schedule deleted", Severity.Success);
            }
            catch (Exception)
            {
                Snackbar.Add("Failed to delete schedule", Severity.Error);
            }
        }
    }

    private string FormatEnumName(string enumValue)
    {
        return System.Text.RegularExpressions.Regex.Replace(enumValue, "([a-z])([A-Z])", "$1 $2");
    }

}