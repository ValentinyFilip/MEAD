@page "/login"
@using BlazorFrontend.Dtos
@using BlazorFrontend.Services
@rendermode InteractiveServer
@layout BlankLayout
@inject IHttpClientFactory HttpClientFactory
@inject IAuthState AuthState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="min-height: 100vh;">
    <MudPaper Elevation="8" Class="pa-8" Width="100%">
        <MudStack Spacing="4">
            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.Medication" Size="Size.Large" Color="Color.Primary"
                         Style="font-size: 4rem;"/>
                <MudText Typo="Typo.h4" Align="Align.Center">MEAD</MudText>
                <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
                    Medication Tracker
                </MudText>
            </MudStack>

            <MudDivider/>

            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0"
                     @bind-ActivePanelIndex="@_activeTab">
                <MudTabPanel Text="Sign In" Icon="@Icons.Material.Filled.Login">
                    <EditForm Model="@this" OnValidSubmit="HandleSubmitAsync">
                        <DataAnnotationsValidator/>

                        <MudStack Spacing="3" Class="mt-4">
                            <MudTextField
                                @bind-Value="LoginString"
                                Label="Email or Username"
                                Variant="Variant.Outlined"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Person"
                                Required="true"
                                RequiredError="Email or username is required"/>

                            <MudTextField
                                @bind-Value="Password"
                                Label="Password"
                                Variant="Variant.Outlined"
                                InputType="@_passwordInputType"
                                Adornment="Adornment.End"
                                AdornmentIcon="@_passwordIcon"
                                OnAdornmentClick="TogglePasswordVisibility"
                                AdornmentAriaLabel="Show Password"
                                Required="true"
                                RequiredError="Password is required"/>

                            <MudButton
                                ButtonType="ButtonType.Submit"
                                Variant="Variant.Filled"
                                Color="Color.Primary"
                                FullWidth="true"
                                Size="Size.Large"
                                Disabled="@_isLoading">
                                @if (_isLoading)
                                {
                                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true"/>
                                    <MudText>Signing in...</MudText>
                                }
                                else
                                {
                                    <MudText>Sign In</MudText>
                                }
                            </MudButton>
                        </MudStack>
                    </EditForm>
                </MudTabPanel>

                <MudTabPanel Text="Register" Icon="@Icons.Material.Filled.PersonAdd">
                    <EditForm Model="@this" OnValidSubmit="HandleSubmitAsync">
                        <DataAnnotationsValidator/>

                        <MudStack Spacing="3" Class="mt-4">
                            <MudTextField
                                @bind-Value="LoginString"
                                Label="Email or Username"
                                Variant="Variant.Outlined"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Person"
                                Required="true"
                                RequiredError="Email or username is required"/>

                            <MudTextField
                                @bind-Value="Password"
                                Label="Password"
                                Variant="Variant.Outlined"
                                InputType="@_passwordInputType"
                                Adornment="Adornment.End"
                                AdornmentIcon="@_passwordIcon"
                                OnAdornmentClick="TogglePasswordVisibility"
                                AdornmentAriaLabel="Show Password"
                                Required="true"
                                RequiredError="Password is required"
                                HelperText="At least 6 characters"/>

                            <MudTextField
                                @bind-Value="PasswordConfirm"
                                Label="Confirm Password"
                                Variant="Variant.Outlined"
                                InputType="@_passwordConfirmInputType"
                                Adornment="Adornment.End"
                                AdornmentIcon="@_passwordConfirmIcon"
                                OnAdornmentClick="TogglePasswordConfirmVisibility"
                                AdornmentAriaLabel="Show Password"
                                Required="true"
                                RequiredError="Password confirmation is required"/>

                            <MudButton
                                ButtonType="ButtonType.Submit"
                                Variant="Variant.Filled"
                                Color="Color.Primary"
                                FullWidth="true"
                                Size="Size.Large"
                                Disabled="@_isLoading">
                                @if (_isLoading)
                                {
                                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true"/>
                                    <MudText>Creating account...</MudText>
                                }
                                else
                                {
                                    <MudText>Create Account</MudText>
                                }
                            </MudButton>
                        </MudStack>
                    </EditForm>
                </MudTabPanel>
            </MudTabs>

            @if (!string.IsNullOrEmpty(_error))
            {
                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" ShowCloseIcon="true"
                          CloseIconClicked="@(() => _error = null)">
                    @_error
                </MudAlert>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private int _activeTab = 0;
    private bool IsLoginMode => _activeTab == 0;

    public string LoginString { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
    public string PasswordConfirm { get; set; } = string.Empty;

    private string? _error;
    private bool _isLoading = false;

    // Password visibility for main password field
    private bool _passwordVisible = false;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    // Password visibility for confirm password field
    private bool _passwordConfirmVisible = false;
    private InputType _passwordConfirmInputType = InputType.Password;
    private string _passwordConfirmIcon = Icons.Material.Filled.VisibilityOff;

    private void SwitchMode(bool login)
    {
        _activeTab = login ? 0 : 1;
        _error = null;
        Password = string.Empty;
        PasswordConfirm = string.Empty;
    }

    private void TogglePasswordVisibility()
    {
        if (_passwordVisible)
        {
            _passwordVisible = false;
            _passwordInputType = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _passwordVisible = true;
            _passwordInputType = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
    }

    private void TogglePasswordConfirmVisibility()
    {
        if (_passwordConfirmVisible)
        {
            _passwordConfirmVisible = false;
            _passwordConfirmInputType = InputType.Password;
            _passwordConfirmIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _passwordConfirmVisible = true;
            _passwordConfirmInputType = InputType.Text;
            _passwordConfirmIcon = Icons.Material.Filled.Visibility;
        }
    }

    private async Task HandleSubmitAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var client = HttpClientFactory.CreateClient("AuthApi");

            if (_activeTab == 0) // Sign In
            {
                var loginRequest = new LoginRequest(LoginString, Password);
                var response = await client.PostAsJsonAsync("/api/auth/login", loginRequest);

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<TokenResponse>();
                    if (result != null)
                    {
                        // Make sure to save both userId and token
                        await AuthState.SetAuthAsync(result.UserId, result.AccessToken);

                        // Verify token was saved
                        var savedToken = await AuthState.GetAccessTokenAsync();
                        if (string.IsNullOrEmpty(savedToken))
                        {
                            _error = "Failed to save authentication token";
                            return;
                        }

                        Navigation.NavigateTo("/", forceLoad: true);
                        Snackbar.Add("Signed in successfully", Severity.Success);
                    }
                    else
                    {
                        _error = "Invalid response from server";
                    }
                }
                else
                {
                    _error = "Invalid credentials. Please try again.";
                }
            }
            else // Register
            {
                if (Password != PasswordConfirm)
                {
                    _error = "Passwords do not match";
                    return;
                }

                var registerRequest = new RegisterRequest(LoginString, Password, PasswordConfirm);
                var response = await client.PostAsJsonAsync("/api/auth/register", registerRequest);

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<TokenResponse>();
                    if (result != null)
                    {
                        await AuthState.SetAuthAsync(result.UserId, result.AccessToken);

                        // Verify token was saved
                        var savedToken = await AuthState.GetAccessTokenAsync();
                        if (string.IsNullOrEmpty(savedToken))
                        {
                            _error = "Failed to save authentication token";
                            return;
                        }

                        Navigation.NavigateTo("/", forceLoad: true);
                        Snackbar.Add("Account created successfully", Severity.Success);
                    }
                    else
                    {
                        _error = "Invalid response from server";
                    }
                }
                else
                {
                    _error = "Registration failed. User may already exist.";
                }
            }
        }
        catch (Exception ex)
        {
            _error = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private sealed record LoginRequest(string Login, string Password);

    private sealed record RegisterRequest(string Login, string Password, string PasswordConfirm);

}
