@page "/medications"
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">Medication Management</MudText>

<MudCard Class="mb-4">
    <MudCardContent>
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_medication.Name" Label="Medication Name" Required="true"/>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_medication.Dosage" Label="Dosage" Required="true"/>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudSelect @bind-Value="_medication.Frequency" Label="Frequency" Required="true">
                    <MudSelectItem Value="@("Once Daily")">Once Daily</MudSelectItem>
                    <MudSelectItem Value="@("Twice Daily")">Twice Daily</MudSelectItem>
                    <MudSelectItem Value="@("Three Times Daily")">Three Times Daily</MudSelectItem>
                    <MudSelectItem Value="@("As Needed")">As Needed</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTimePicker @bind-Time="_medication.Time" Label="Time"/>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_medication.Instructions" Label="Instructions" Lines="3"/>
            </MudItem>
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveMedication">
                    @(_isEditing ? "Update" : "Add") Medication
                </MudButton>
                @if (_isEditing)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="ml-2" OnClick="CancelEdit">
                        Cancel
                    </MudButton>
                }
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

<MudCard>
    <MudCardHeader>
        <MudText Typo="Typo.h6">Your Medications</MudText>
    </MudCardHeader>
    <MudCardContent>
        <MudTable Items="@_medications" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
                  Filter="new Func<Medication,bool>(FilterFunc)">
            <ToolBarContent>
                <MudTextField @bind-Value="_searchString" Placeholder="Search medications" Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                              Class="mt-0"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Dosage</MudTh>
                <MudTh>Frequency</MudTh>
                <MudTh>Time</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Dosage">@context.Dosage</MudTd>
                <MudTd DataLabel="Frequency">@context.Frequency</MudTd>
                <MudTd DataLabel="Time">@context.Time?.ToString("hh:mm tt")</MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                   Size="Size.Small" OnClick="@(() => EditMedication(context))"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                   Size="Size.Small" OnClick="@(() => DeleteMedication(context))"/>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager/>
            </PagerContent>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private readonly List<Medication> _medications = [];
    private Medication _medication = new();
    private bool _loading = false;
    private bool _isEditing = false;
    private string _searchString = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadMedications();
    }

    private async Task LoadMedications()
    {
        _loading = true;
        // TODO: Call your API service here
        // medications = await MedicationService.GetAllAsync();
        _loading = false;
    }

    private async Task SaveMedication()
    {
        if (_isEditing)
        {
            // TODO: Update medication
            // await MedicationService.UpdateAsync(medication);
            Snackbar.Add("Medication updated successfully", Severity.Success);
        }
        else
        {
            // TODO: Add medication
            // await MedicationService.AddAsync(medication);
            Snackbar.Add("Medication added successfully", Severity.Success);
        }

        _medication = new Medication();
        _isEditing = false;
        await LoadMedications();
    }

    private void EditMedication(Medication med)
    {
        _medication = med;
        _isEditing = true;
    }

    private async Task DeleteMedication(Medication med)
    {
        // TODO: Delete medication
        // await MedicationService.DeleteAsync(med.Id);
        Snackbar.Add("Medication deleted successfully", Severity.Success);
        await LoadMedications();
    }

    private void CancelEdit()
    {
        _medication = new Medication();
        _isEditing = false;
    }

    private bool FilterFunc(Medication med) => FilterFunc(med, _searchString);

    private bool FilterFunc(Medication med, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (med.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (med.Dosage.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    public class Medication
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Dosage { get; set; } = string.Empty;
        public string Frequency { get; set; } = string.Empty;
        public TimeSpan? Time { get; set; }
        public string Instructions { get; set; } = string.Empty;
    }

}